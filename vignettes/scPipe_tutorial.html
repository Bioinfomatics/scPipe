<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Luyi Tian" />

<meta name="date" content="2017-07-26" />

<title>scPipe: flexible data preprocessing pipeline for 3’ end scRNA-seq data</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">scPipe: flexible data preprocessing pipeline for 3’ end scRNA-seq data</h1>
<h4 class="author"><em>Luyi Tian</em></h4>
<h4 class="date"><em>2017-07-26</em></h4>



<div id="get-started" class="section level1">
<h1>Get started</h1>
<p><code>scPipe</code> is a package designed to process scRNA-seq data generated by different protocols. It is designed for protocols with UMI, but can also adapt to non-UMI protocols. scPipe consist of two major components. The first is data preprocessing with raw fastq as input and gene counting matrix as output. The second component starts from gene counting matrix, includes quality control and a shiny app for clustering and visualization.</p>
</div>
<div id="case-study-simulate-and-process-cel-seq2-data" class="section level1">
<h1>case study: simulate and process CEL-seq2 data</h1>
<div id="simulate-a-simple-cel-seq2-dataset." class="section level2">
<h2>simulate a simple CEL-seq2 dataset.</h2>
<p>we start from creating a folder to store all results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(scPipe)
data_dir =<span class="st"> &quot;celseq2_demo&quot;</span>
<span class="kw">dir.create</span>(<span class="st">&quot;celseq2_demo&quot;</span>, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>CEL-seq2 is a modified version of CEL-Seq method with higher sensitivity and lower costs. It uses a polyT primer with index sequences to capture cell’s mRNA. The index sequence consist of the a cellular specific index, which is designed and the same for each cell, and a molecular index, also called unique molecular identifier (UMI), which is randomly generated and different for each primer. The ouput fastq of Cel-seq2 is paired-ended where the first read is transcript and second read is cellindex+UMI with some polyA sequence.</p>
<p>to simulate a CEL-seq2 dataset. We need the genome fasta file, gff3 exon annotation and a cell barcode annotation. The barcode annotation should be a <code>.csv</code> file with at least have two column where first column is the cell id and second column is the barcode sequence. We use ERCC in this demo. All file can be found in <code>extdata</code> in this package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># file path:</span>
ERCCfa_fn =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;ERCC92.fa&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;scPipe&quot;</span>)
ERCCanno_fn =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;ERCC92_anno.gff3&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;scPipe&quot;</span>)
barcode_annotation_fn =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;barcode_anno.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;scPipe&quot;</span>)</code></pre></div>
<p>We start from simulating the paired-end fastq files. Read1 contains transcript and Read2 contains UMI followed by cell barcode. For simplixity we use default parameters, more parameter see <code>?sc_celseq2_simulator</code>. The read structure for CEL-seq2 is a paired-ended reads with first longer read mapped to transcript and second shorter read consist of 6bp UMI followed by 8bp cell barcode.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sc_celseq2_simulator</span>(<span class="kw">file.path</span>(data_dir, <span class="st">&quot;simu_R1.fastq&quot;</span>),
                     <span class="kw">file.path</span>(data_dir, <span class="st">&quot;simu_R2.fastq&quot;</span>),
                     ERCCanno_fn,
                     barcode_annotation_fn,
                     ERCCfa_fn)</code></pre></div>
</div>
<div id="data-proprocessing" class="section level2">
<h2>data proprocessing</h2>
<p>The pipeline begin with fastq file reformatting. We move the barcode and UMI to the read name and keep the transcript, so the output read name looks like <code>@[barcode_sequence]*[UMI_sequence]#[readname]</code> …</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sc_trim_barcode</span>(<span class="kw">file.path</span>(data_dir, <span class="st">&quot;combined.fastq&quot;</span>),
                <span class="kw">file.path</span>(data_dir, <span class="st">&quot;simu_R1.fastq&quot;</span>),
                <span class="kw">file.path</span>(data_dir, <span class="st">&quot;simu_R2.fastq&quot;</span>))</code></pre></div>
<p>Then we align the reads to genome. The example uses <code>Rsubread</code> but it can be any aligner that support RNA-seq alignment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Rsubread)
<span class="kw">dir.create</span>(<span class="st">&quot;celseq2_demo/index&quot;</span>)
<span class="kw">buildindex</span>(<span class="dt">basename=</span><span class="st">&quot;celseq2_demo/index/ERCC_index&quot;</span>, <span class="dt">reference=</span>ERCCfa_fn)

<span class="kw">align</span>(<span class="dt">index=</span><span class="st">&quot;celseq2_demo/index/ERCC_index&quot;</span>,
      <span class="dt">readfile1=</span><span class="kw">file.path</span>(data_dir, <span class="st">&quot;combined.fastq&quot;</span>),
      <span class="dt">output_file=</span><span class="kw">file.path</span>(data_dir, <span class="st">&quot;out.aln.bam&quot;</span>), <span class="dt">phredOffset=</span><span class="dv">64</span>)</code></pre></div>
<p>After alignment we will map reads to exons using the exon annotations. Currently <code>scPipe</code> only supports annotation in <code>gff3</code> and <code>bed</code> format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sc_exon_mapping</span>(<span class="kw">file.path</span>(data_dir, <span class="st">&quot;out.aln.bam&quot;</span>),
                <span class="kw">file.path</span>(data_dir, <span class="st">&quot;out.map.bam&quot;</span>),
                ERCCanno_fn)</code></pre></div>
<p>Next we use <code>sc_demultiplex()</code> to split the reads to each cell and put them into spearate <code>.csv</code> file in <code>/count</code> subfolder. Each file contains three column. Each row is a read and first column is the gene is that this read mapped to, second column is the UMI sequence of this read, the third column is the distance to transcript end position. This file will be used for UMI deduplication and to generate gene counting matrix by callling <code>sc_gene_counting()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sc_demultiplex</span>(<span class="kw">file.path</span>(data_dir, <span class="st">&quot;out.map.bam&quot;</span>), data_dir, barcode_annotation_fn,<span class="dt">has_UMI=</span><span class="ot">FALSE</span>)

<span class="kw">sc_gene_counting</span>(data_dir, barcode_annotation_fn)</code></pre></div>
</div>
<div id="do-everything-in-one-line-of-code." class="section level2">
<h2>do everything in one line of code.</h2>
<p>The tutorial above separate each step, however we also provided a function called <code>run_scPipe</code> to integrate them into one step. the <code>run_scPipe</code> includes an argument <code>report</code> which can be set to <code>TRUE</code> to generate an Rmarkdown report with both html report and runnable rmd source code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scd =<span class="st"> </span><span class="kw">run_scPipe</span>(<span class="dt">sample_name=</span><span class="st">&quot;celseq2_demo&quot;</span>,
          <span class="dt">outdir=</span><span class="st">&quot;celseq2_demo&quot;</span>,
          <span class="dt">r1=</span><span class="kw">file.path</span>(<span class="st">&quot;celseq2_demo&quot;</span>, <span class="st">&quot;simu_R1.fastq&quot;</span>),
          <span class="dt">r2=</span><span class="kw">file.path</span>(<span class="st">&quot;celseq2_demo&quot;</span>, <span class="st">&quot;simu_R1.fastq&quot;</span>),
          <span class="dt">read_structure=</span><span class="kw">list</span>(<span class="dt">bs1 =</span> -<span class="dv">1</span>, <span class="dt">bl1 =</span> <span class="dv">2</span>, <span class="dt">bs2 =</span> <span class="dv">6</span>, <span class="dt">bl2 =</span> <span class="dv">8</span>, <span class="dt">us =</span> <span class="dv">0</span>, <span class="dt">ul =</span> <span class="dv">6</span>),
          <span class="dt">filter_settings =</span> <span class="kw">list</span>(<span class="dt">rmlow =</span> <span class="ot">TRUE</span>, <span class="dt">rmN =</span> <span class="ot">TRUE</span>, <span class="dt">minq =</span> <span class="dv">20</span>, <span class="dt">numbq =</span> <span class="dv">2</span>),
          <span class="dt">genome_index=</span><span class="st">&quot;celseq2_demo/index/ERCC_index&quot;</span>,
          <span class="dt">exon_anno=</span>ERCCanno_fn,
          <span class="dt">barcode_anno=</span>barcode_annotation_fn,
          <span class="dt">max_mis=</span><span class="dv">1</span>,
          <span class="dt">UMI_cor=</span><span class="dv">1</span>,
          <span class="dt">gene_fl=</span><span class="ot">FALSE</span>,
          <span class="dt">report=</span><span class="ot">FALSE</span>)</code></pre></div>
<p>Now we complete the preprocessing step. you will find the gene counting matrix at <code>data_dir/gene_count.csv</code> and quality control statistics in <code>data_dir/stat</code> folder, which can be used for quality control.</p>
</div>
</div>
<div id="process-data-generated-by-other-protocols" class="section level1">
<h1>process data generated by other protocols</h1>
<p>the most difference that come from different protocols is the read structure, which is defined by <code>read_structure</code> argument in scPipe. The difference between CEL-seq and Drop-seq is the cell barcode is unknown for Drop-seq, so an extra step <code>sc_detect_bc</code> is required before <code>sc_demultiplex</code>, to identify and generate the cell barcode annotation. To use <code>run_scPipe</code> on Drop-seq data, just ignore the <code>barcode_anno</code> argument. scPipe is not optimized for the full-lengh protocols like SMART-seq, but it can process the data generated by such protocol by set the <code>has_UMI</code> to <code>FALSE</code> in <code>sc_demultiplex</code> or <code>run_scPipe</code>.</p>
<div id="quality-control" class="section level2">
<h2>quality control</h2>
<p>TODO</p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
